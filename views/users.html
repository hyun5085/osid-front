<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-white">User Management</h2>
                    <p class="text-muted">Manage customers and their accounts</p>
                </div>
                <div>
                    <button class="btn btn-primary" id="addUserBtn">
                        <i class="fas fa-plus me-2"></i>Add User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="userSearchInput" class="form-label">Search Users</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="userSearchInput" placeholder="Name, email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                        <option value="SUSPENDED">Suspended</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label">Registration Date</label>
                    <select class="form-select" id="dateFilter">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-primary" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i>Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>Users List
            </h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" id="exportBtn">
                    <i class="fas fa-download me-1"></i>Export
                </button>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Orders</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <br>Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="Users pagination" id="paginationContainer">
                <ul class="pagination justify-content-center mt-4">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>User Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editUserFromDetailsBtn">
                    <i class="fas fa-edit me-1"></i>Edit User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade" id="userFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userFormTitle">
                    <i class="fas fa-user-plus me-2"></i>Add New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="userName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="userEmail" name="email" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userPhone" class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="userPhone" name="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userStatus" class="form-label">Status</label>
                            <select class="form-select" id="userStatus" name="status">
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                                <option value="SUSPENDED">Suspended</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="userAddress" name="address" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userDateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="userDateOfBirth" name="dateOfBirth">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userGender" class="form-label">Gender</label>
                            <select class="form-select" id="userGender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="MALE">Male</option>
                                <option value="FEMALE">Female</option>
                                <option value="OTHER">Other</option>
                                <option value="PREFER_NOT_TO_SAY">Prefer not to say</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userDriverLicense" class="form-label">Driver License Number</label>
                            <input type="text" class="form-control" id="userDriverLicense" name="driverLicense">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userPreferredDealer" class="form-label">Preferred Dealer</label>
                            <select class="form-select" id="userPreferredDealer" name="preferredDealerId">
                                <option value="">Select Dealer</option>
                                <!-- Dealers will be loaded here -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="userNotes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="userEmailNotifications" name="emailNotifications">
                            <label class="form-check-label" for="userEmailNotifications">
                                Enable email notifications
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="userForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Users page functionality
let currentEditingUserId = null;
let currentPage = 1;
const pageSize = 10;

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadDealersForSelect();
    
    // Setup event listeners
    document.getElementById('addUserBtn')?.addEventListener('click', function() {
        showUserForm();
    });
    
    document.getElementById('userForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveUser();
    });
    
    document.getElementById('applyFiltersBtn')?.addEventListener('click', function() {
        currentPage = 1;
        loadUsers();
    });
    
    document.getElementById('refreshBtn')?.addEventListener('click', function() {
        loadUsers();
    });
    
    // Setup search with debounce
    const searchInput = document.getElementById('userSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', utils.debounce(() => {
            currentPage = 1;
            loadUsers();
        }, 500));
    }
});

async function loadUsers() {
    try {
        const searchTerm = document.getElementById('userSearchInput')?.value || '';
        const status = document.getElementById('statusFilter')?.value || '';
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        
        const params = {
            page: currentPage - 1,
            size: pageSize
        };
        
        if (searchTerm) params.search = searchTerm;
        if (status) params.status = status;
        if (dateFilter) params.dateFilter = dateFilter;
        
        const response = await api.users.getAll(params);
        const users = response.data || [];
        const totalUsers = response.totalElements || 0;
        
        const usersTableBody = document.getElementById('usersTableBody');
        
        if (users.length === 0) {
            usersTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-users fa-2x mb-3"></i>
                        <br>No users found
                    </td>
                </tr>
            `;
            return;
        }
        
        const usersHTML = users.map(user => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle me-2 text-muted"></i>
                        <div>
                            <div class="fw-bold">${user.name || 'N/A'}</div>
                            ${user.driverLicense ? `<small class="text-muted">DL: ${user.driverLicense}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <a href="mailto:${user.email}" class="text-decoration-none">
                        ${user.email || 'N/A'}
                    </a>
                    ${user.emailNotifications ? '<i class="fas fa-bell ms-1 text-info" title="Notifications enabled"></i>' : ''}
                </td>
                <td>
                    ${user.phone ? `<a href="tel:${user.phone}" class="text-decoration-none">${user.phone}</a>` : 'N/A'}
                </td>
                <td>${utils.getStatusBadge(user.status || 'ACTIVE')}</td>
                <td>
                    <span class="badge bg-primary">${user.totalOrders || 0}</span>
                </td>
                <td>${utils.formatDate(user.createdAt)}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails(${user.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="editUser(${user.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="viewUserOrders(${user.id})" title="View Orders">
                            <i class="fas fa-clipboard-list"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="suspendUser(${user.id})" title="Suspend">
                            <i class="fas fa-ban"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        usersTableBody.innerHTML = usersHTML;
        
        // Update pagination
        updatePagination(totalUsers);
        
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <br>Error loading users
                </td>
            </tr>
        `;
    }
}

async function loadDealersForSelect() {
    try {
        const response = await api.dealers.getAll();
        const dealers = response.data || [];
        
        const dealerSelect = document.getElementById('userPreferredDealer');
        if (dealerSelect) {
            dealerSelect.innerHTML = '<option value="">Select Dealer</option>' +
                dealers.map(dealer => `<option value="${dealer.id}">${dealer.name} - ${dealer.branch}</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading dealers:', error);
    }
}

function updatePagination(totalUsers) {
    const totalPages = Math.ceil(totalUsers / pageSize);
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let paginationHTML = '<ul class="pagination justify-content-center mt-4">';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    paginationHTML += '</ul>';
    paginationContainer.innerHTML = paginationHTML;
}

function changePage(newPage) {
    currentPage = newPage;
    loadUsers();
}

function showUserForm(userData = null) {
    const modal = new bootstrap.Modal(document.getElementById('userFormModal'));
    const title = document.getElementById('userFormTitle');
    const form = document.getElementById('userForm');
    
    if (userData) {
        title.innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit User';
        currentEditingUserId = userData.id;
        
        // Populate form with user data
        Object.keys(userData).forEach(key => {
            const field = document.getElementById('user' + key.charAt(0).toUpperCase() + key.slice(1));
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = !!userData[key];
                } else if (field.type === 'date' && userData[key]) {
                    field.value = new Date(userData[key]).toISOString().split('T')[0];
                } else if (userData[key] !== null && userData[key] !== undefined) {
                    field.value = userData[key];
                }
            }
        });
    } else {
        title.innerHTML = '<i class="fas fa-user-plus me-2"></i>Add New User';
        currentEditingUserId = null;
        form.reset();
        // Set default values
        document.getElementById('userStatus').value = 'ACTIVE';
        document.getElementById('userEmailNotifications').checked = true;
    }
    
    modal.show();
}

async function saveUser() {
    try {
        const form = document.getElementById('userForm');
        const formData = new FormData(form);
        const userData = {};
        
        for (const [key, value] of formData.entries()) {
            if (value !== '') {
                userData[key] = value;
            }
        }
        
        // Handle checkbox
        userData.emailNotifications = document.getElementById('userEmailNotifications').checked;
        
        // Validate form
        const errors = utils.validateForm(form);
        if (errors.length > 0) {
            utils.showToast('Please fix the form errors: ' + errors.join(', '), 'error');
            return;
        }
        
        let response;
        if (currentEditingUserId) {
            response = await api.users.update(currentEditingUserId, userData);
        } else {
            // For new users, we need to use the signup endpoint
            response = await api.users.signup({
                ...userData,
                password: 'defaultPassword123' // Default password that should be changed
            });
        }
        
        if (response) {
            utils.showToast('User saved successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('userFormModal')).hide();
            loadUsers(); // Refresh the users list
        }
        
    } catch (error) {
        console.error('Error saving user:', error);
        utils.showToast('Error saving user. Please try again.', 'error');
    }
}

async function editUser(userId) {
    try {
        const response = await api.users.getById(userId);
        if (response && response.data) {
            showUserForm(response.data);
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        utils.showToast('Error loading user details', 'error');
    }
}

async function viewUserDetails(userId) {
    try {
        const response = await api.users.getById(userId);
        if (response && response.data) {
            const user = response.data;
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Personal Information</h6>
                        <table class="table table-sm table-dark">
                            <tr><td><strong>Name:</strong></td><td>${user.name || 'N/A'}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${user.email || 'N/A'}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${user.phone || 'N/A'}</td></tr>
                            <tr><td><strong>Date of Birth:</strong></td><td>${utils.formatDate(user.dateOfBirth)}</td></tr>
                            <tr><td><strong>Gender:</strong></td><td>${user.gender || 'N/A'}</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${user.address || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Account Information</h6>
                        <table class="table table-sm table-dark">
                            <tr><td><strong>Status:</strong></td><td>${utils.getStatusBadge(user.status)}</td></tr>
                            <tr><td><strong>Driver License:</strong></td><td>${user.driverLicense || 'N/A'}</td></tr>
                            <tr><td><strong>Preferred Dealer:</strong></td><td>${user.preferredDealerName || 'N/A'}</td></tr>
                            <tr><td><strong>Email Notifications:</strong></td><td>${user.emailNotifications ? 'Enabled' : 'Disabled'}</td></tr>
                            <tr><td><strong>Total Orders:</strong></td><td>${user.totalOrders || 0}</td></tr>
                            <tr><td><strong>Member Since:</strong></td><td>${utils.formatDate(user.createdAt)}</td></tr>
                        </table>
                    </div>
                </div>
                ${user.notes ? `
                <div class="mt-3">
                    <h6>Notes</h6>
                    <p class="text-muted">${user.notes}</p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('userDetailsContent').innerHTML = detailsHTML;
            
            // Setup edit button
            document.getElementById('editUserFromDetailsBtn').onclick = function() {
                bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();
                showUserForm(user);
            };
            
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        utils.showToast('Error loading user details', 'error');
    }
}

function viewUserOrders(userId) {
    // Navigate to orders page with user filter
    app.router.navigate('orders', { userId: userId });
}

async function suspendUser(userId) {
    utils.showConfirmModal(
        'Suspend User',
        'Are you sure you want to suspend this user? They will not be able to access the system.',
        async () => {
            try {
                await api.users.update(userId, { status: 'SUSPENDED' });
                utils.showToast('User suspended successfully!', 'warning');
                loadUsers();
            } catch (error) {
                console.error('Error suspending user:', error);
                utils.showToast('Error suspending user', 'error');
            }
        }
    );
}
</script>
