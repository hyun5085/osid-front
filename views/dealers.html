<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-white">Dealer Management</h2>
                    <p class="text-muted">Manage dealers and their permissions</p>
                </div>
                <div>
                    <button class="btn btn-primary" id="addDealerBtn">
                        <i class="fas fa-plus me-2"></i>Add Dealer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="dealerSearchInput" class="form-label">Search Dealers</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="dealerSearchInput" placeholder="Name, email, branch...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="branchFilter" class="form-label">Branch</label>
                    <select class="form-select" id="branchFilter">
                        <option value="">All Branches</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                        <option value="SUSPENDED">Suspended</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-primary" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i>Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dealers Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-store me-2"></i>Dealers List
            </h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" id="exportBtn">
                    <i class="fas fa-download me-1"></i>Export
                </button>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Branch</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dealersTableBody">
                        <!-- Dealers will be loaded here -->
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <br>Loading dealers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Dealer Details Modal -->
<div class="modal fade" id="dealerDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-store me-2"></i>Dealer Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dealerDetailsContent">
                <!-- Dealer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editDealerFromDetailsBtn">
                    <i class="fas fa-edit me-1"></i>Edit Dealer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Dealer Modal -->
<div class="modal fade" id="dealerFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dealerFormTitle">
                    <i class="fas fa-store me-2"></i>Add New Dealer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dealerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dealerName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="dealerName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dealerEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="dealerEmail" name="email" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dealerPhone" class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="dealerPhone" name="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dealerBranch" class="form-label">Branch/Location *</label>
                            <input type="text" class="form-control" id="dealerBranch" name="branch" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dealerRole" class="form-label">Role</label>
                            <select class="form-select" id="dealerRole" name="role">
                                <option value="DEALER">Standard Dealer</option>
                                <option value="SENIOR_DEALER">Senior Dealer</option>
                                <option value="MANAGER">Branch Manager</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dealerStatus" class="form-label">Status</label>
                            <select class="form-select" id="dealerStatus" name="status">
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                                <option value="SUSPENDED">Suspended</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dealerAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="dealerAddress" name="address" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dealerHireDate" class="form-label">Hire Date</label>
                            <input type="date" class="form-control" id="dealerHireDate" name="hireDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dealerSalary" class="form-label">Base Salary</label>
                            <input type="number" class="form-control" id="dealerSalary" name="baseSalary" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dealerNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="dealerNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="dealerForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save Dealer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Dealers page functionality
let currentEditingDealerId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadDealers();
    
    // Setup event listeners
    document.getElementById('addDealerBtn')?.addEventListener('click', function() {
        showDealerForm();
    });
    
    document.getElementById('dealerForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveDealer();
    });
    
    document.getElementById('applyFiltersBtn')?.addEventListener('click', function() {
        loadDealers();
    });
    
    document.getElementById('refreshBtn')?.addEventListener('click', function() {
        loadDealers();
    });
    
    // Setup search with debounce
    const searchInput = document.getElementById('dealerSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', utils.debounce(loadDealers, 500));
    }
});

async function loadDealers() {
    try {
        const searchTerm = document.getElementById('dealerSearchInput')?.value || '';
        const branch = document.getElementById('branchFilter')?.value || '';
        const status = document.getElementById('statusFilter')?.value || '';
        
        const params = {};
        if (searchTerm) params.search = searchTerm;
        if (branch) params.branch = branch;
        if (status) params.status = status;
        
        const response = await api.dealers.getAll(params);
        const dealers = response.data || [];
        
        const dealersTableBody = document.getElementById('dealersTableBody');
        
        if (dealers.length === 0) {
            dealersTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-store fa-2x mb-3"></i>
                        <br>No dealers found
                    </td>
                </tr>
            `;
            return;
        }
        
        // Update branch filter options
        updateBranchFilter(dealers);
        
        const dealersHTML = dealers.map(dealer => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-tie me-2 text-muted"></i>
                        <div>
                            <div class="fw-bold">${dealer.name || 'N/A'}</div>
                            ${dealer.role ? `<small class="text-muted">${dealer.role}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <a href="mailto:${dealer.email}" class="text-decoration-none">
                        ${dealer.email || 'N/A'}
                    </a>
                </td>
                <td>
                    <i class="fas fa-map-marker-alt me-1 text-muted"></i>
                    ${dealer.branch || 'N/A'}
                </td>
                <td>
                    ${dealer.phone ? `<a href="tel:${dealer.phone}" class="text-decoration-none">${dealer.phone}</a>` : 'N/A'}
                </td>
                <td>${utils.getStatusBadge(dealer.status || 'ACTIVE')}</td>
                <td>${utils.formatDate(dealer.createdAt)}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewDealerDetails(${dealer.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="editDealer(${dealer.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="updateDealerRole(${dealer.id})" title="Update Role">
                            <i class="fas fa-user-cog"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="suspendDealer(${dealer.id})" title="Suspend">
                            <i class="fas fa-ban"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        dealersTableBody.innerHTML = dealersHTML;
        
    } catch (error) {
        console.error('Error loading dealers:', error);
        document.getElementById('dealersTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <br>Error loading dealers
                </td>
            </tr>
        `;
    }
}

function updateBranchFilter(dealers) {
    const branchFilter = document.getElementById('branchFilter');
    if (!branchFilter) return;
    
    const currentValue = branchFilter.value;
    const branches = [...new Set(dealers.map(dealer => dealer.branch).filter(branch => branch))];
    
    branchFilter.innerHTML = '<option value="">All Branches</option>' + 
        branches.map(branch => `<option value="${branch}">${branch}</option>`).join('');
    
    if (currentValue && branches.includes(currentValue)) {
        branchFilter.value = currentValue;
    }
}

function showDealerForm(dealerData = null) {
    const modal = new bootstrap.Modal(document.getElementById('dealerFormModal'));
    const title = document.getElementById('dealerFormTitle');
    const form = document.getElementById('dealerForm');
    
    if (dealerData) {
        title.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Dealer';
        currentEditingDealerId = dealerData.id;
        
        // Populate form with dealer data
        Object.keys(dealerData).forEach(key => {
            const field = document.getElementById('dealer' + key.charAt(0).toUpperCase() + key.slice(1));
            if (field && dealerData[key] !== null && dealerData[key] !== undefined) {
                if (field.type === 'date' && dealerData[key]) {
                    field.value = new Date(dealerData[key]).toISOString().split('T')[0];
                } else {
                    field.value = dealerData[key];
                }
            }
        });
    } else {
        title.innerHTML = '<i class="fas fa-store me-2"></i>Add New Dealer';
        currentEditingDealerId = null;
        form.reset();
        // Set default values
        document.getElementById('dealerRole').value = 'DEALER';
        document.getElementById('dealerStatus').value = 'ACTIVE';
    }
    
    modal.show();
}

async function saveDealer() {
    try {
        const form = document.getElementById('dealerForm');
        const formData = new FormData(form);
        const dealerData = {};
        
        for (const [key, value] of formData.entries()) {
            if (value !== '') {
                dealerData[key] = value;
            }
        }
        
        // Validate form
        const errors = utils.validateForm(form);
        if (errors.length > 0) {
            utils.showToast('Please fix the form errors: ' + errors.join(', '), 'error');
            return;
        }
        
        let response;
        if (currentEditingDealerId) {
            response = await api.dealers.update(currentEditingDealerId, dealerData);
        } else {
            // For new dealers, we need to use the signup endpoint
            response = await api.dealers.signup({
                ...dealerData,
                password: 'defaultPassword123' // Default password that should be changed
            });
        }
        
        if (response) {
            utils.showToast('Dealer saved successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('dealerFormModal')).hide();
            loadDealers(); // Refresh the dealers list
        }
        
    } catch (error) {
        console.error('Error saving dealer:', error);
        utils.showToast('Error saving dealer. Please try again.', 'error');
    }
}

async function editDealer(dealerId) {
    try {
        const response = await api.dealers.getById(dealerId);
        if (response && response.data) {
            showDealerForm(response.data);
        }
    } catch (error) {
        console.error('Error loading dealer details:', error);
        utils.showToast('Error loading dealer details', 'error');
    }
}

async function viewDealerDetails(dealerId) {
    try {
        const response = await api.dealers.getById(dealerId);
        if (response && response.data) {
            const dealer = response.data;
            
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Personal Information</h6>
                        <table class="table table-sm table-dark">
                            <tr><td><strong>Name:</strong></td><td>${dealer.name || 'N/A'}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${dealer.email || 'N/A'}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${dealer.phone || 'N/A'}</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${dealer.address || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Work Information</h6>
                        <table class="table table-sm table-dark">
                            <tr><td><strong>Branch:</strong></td><td>${dealer.branch || 'N/A'}</td></tr>
                            <tr><td><strong>Role:</strong></td><td>${dealer.role || 'N/A'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td>${utils.getStatusBadge(dealer.status)}</td></tr>
                            <tr><td><strong>Hire Date:</strong></td><td>${utils.formatDate(dealer.hireDate)}</td></tr>
                            <tr><td><strong>Base Salary:</strong></td><td>${utils.formatCurrency(dealer.baseSalary)}</td></tr>
                        </table>
                    </div>
                </div>
                ${dealer.notes ? `
                <div class="mt-3">
                    <h6>Notes</h6>
                    <p class="text-muted">${dealer.notes}</p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('dealerDetailsContent').innerHTML = detailsHTML;
            
            // Setup edit button
            document.getElementById('editDealerFromDetailsBtn').onclick = function() {
                bootstrap.Modal.getInstance(document.getElementById('dealerDetailsModal')).hide();
                showDealerForm(dealer);
            };
            
            const modal = new bootstrap.Modal(document.getElementById('dealerDetailsModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading dealer details:', error);
        utils.showToast('Error loading dealer details', 'error');
    }
}

async function updateDealerRole(dealerId) {
    // This would show a modal to update dealer role
    const newRole = prompt('Enter new role (DEALER, SENIOR_DEALER, MANAGER):');
    if (newRole && ['DEALER', 'SENIOR_DEALER', 'MANAGER'].includes(newRole)) {
        try {
            await api.dealers.updateRole(dealerId, newRole);
            utils.showToast('Dealer role updated successfully!', 'success');
            loadDealers();
        } catch (error) {
            console.error('Error updating dealer role:', error);
            utils.showToast('Error updating dealer role', 'error');
        }
    }
}

async function suspendDealer(dealerId) {
    utils.showConfirmModal(
        'Suspend Dealer',
        'Are you sure you want to suspend this dealer? They will not be able to access the system.',
        async () => {
            try {
                await api.dealers.update(dealerId, { status: 'SUSPENDED' });
                utils.showToast('Dealer suspended successfully!', 'warning');
                loadDealers();
            } catch (error) {
                console.error('Error suspending dealer:', error);
                utils.showToast('Error suspending dealer', 'error');
            }
        }
    );
}
</script>
