<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-white">Car Options</h2>
                    <p class="text-muted">Manage available car options and accessories</p>
                </div>
                <div>
                    <button class="btn btn-primary" id="addOptionBtn">
                        <i class="fas fa-plus me-2"></i>Add Option
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="optionSearchInput" class="form-label">Search Options</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="optionSearchInput" placeholder="Option name, category...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="categoryFilter" class="form-label">Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-primary" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i>Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Options Grid -->
    <div class="row" id="optionsGrid">
        <!-- Options will be loaded here -->
        <div class="col-12 text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
            <p>Loading car options...</p>
        </div>
    </div>
</div>

<!-- Add/Edit Option Modal -->
<div class="modal fade" id="optionFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optionFormTitle">
                    <i class="fas fa-cogs me-2"></i>Add New Option
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="optionForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="optionName" class="form-label">Option Name *</label>
                            <input type="text" class="form-control" id="optionName" name="name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="optionStatus" class="form-label">Status *</label>
                            <select class="form-select" id="optionStatus" name="status" required>
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="optionCategory" class="form-label">Category *</label>
                            <select class="form-select" id="optionCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="EXTERIOR">Exterior</option>
                                <option value="INTERIOR">Interior</option>
                                <option value="TECHNOLOGY">Technology</option>
                                <option value="PERFORMANCE">Performance</option>
                                <option value="SAFETY">Safety</option>
                                <option value="COMFORT">Comfort</option>
                                <option value="ENTERTAINMENT">Entertainment</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="optionPrice" class="form-label">Price *</label>
                            <input type="number" class="form-control" id="optionPrice" name="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="optionCode" class="form-label">Option Code</label>
                            <input type="text" class="form-control" id="optionCode" name="code" placeholder="e.g., NAV001">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="optionInstallTime" class="form-label">Install Time (hours)</label>
                            <input type="number" class="form-control" id="optionInstallTime" name="installTime" step="0.5" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="optionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="optionDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="optionSupplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control" id="optionSupplier" name="supplier">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="optionWarranty" class="form-label">Warranty (months)</label>
                            <input type="number" class="form-control" id="optionWarranty" name="warranty" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optionRequired" name="required">
                            <label class="form-check-label" for="optionRequired">
                                Required Option (Cannot be excluded)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="optionCompatibleModels" class="form-label">Compatible Models</label>
                        <textarea class="form-control" id="optionCompatibleModels" name="compatibleModels" rows="2" placeholder="List compatible model IDs or names, separated by commas"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="optionForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save Option
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Options page functionality
let currentEditingOptionId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadOptions();
    
    // Setup event listeners
    document.getElementById('addOptionBtn')?.addEventListener('click', function() {
        showOptionForm();
    });
    
    document.getElementById('optionForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveOption();
    });
    
    document.getElementById('applyFiltersBtn')?.addEventListener('click', function() {
        loadOptions();
    });
    
    // Setup search with debounce
    const searchInput = document.getElementById('optionSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', utils.debounce(loadOptions, 500));
    }
});

async function loadOptions() {
    try {
        const searchTerm = document.getElementById('optionSearchInput')?.value || '';
        const category = document.getElementById('categoryFilter')?.value || '';
        const status = document.getElementById('statusFilter')?.value || '';
        
        const params = {};
        if (searchTerm) params.search = searchTerm;
        if (category) params.category = category;
        if (status) params.status = status;
        
        const response = await api.options.getAll(params);
        const options = response.data || [];
        
        const optionsGrid = document.getElementById('optionsGrid');
        
        if (options.length === 0) {
            optionsGrid.innerHTML = `
                <div class="col-12 text-center text-muted py-5">
                    <i class="fas fa-cogs fa-3x mb-3"></i>
                    <h4>No Options Found</h4>
                    <p>Start by adding your first car option!</p>
                    <button class="btn btn-primary" onclick="showOptionForm()">
                        <i class="fas fa-plus me-2"></i>Add First Option
                    </button>
                </div>
            `;
            return;
        }
        
        // Update category filter options
        updateCategoryFilter(options);
        
        const optionsHTML = options.map(option => `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">${option.name}</h5>
                            ${utils.getStatusBadge(option.status)}
                        </div>
                        
                        <div class="mb-3">
                            <div class="row text-sm">
                                <div class="col-6">
                                    <strong>Category:</strong> ${option.category || 'N/A'}
                                </div>
                                <div class="col-6">
                                    <strong>Price:</strong> ${utils.formatCurrency(option.price)}
                                </div>
                            </div>
                            ${option.code ? `
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <strong>Code:</strong> ${option.code}
                                </div>
                                <div class="col-6">
                                    <strong>Install:</strong> ${option.installTime ? option.installTime + 'h' : 'N/A'}
                                </div>
                            </div>
                            ` : ''}
                            ${option.supplier ? `
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <strong>Supplier:</strong> ${option.supplier}
                                </div>
                                <div class="col-6">
                                    <strong>Warranty:</strong> ${option.warranty ? option.warranty + ' months' : 'N/A'}
                                </div>
                            </div>
                            ` : ''}
                            ${option.required ? `
                            <div class="mt-2">
                                <span class="badge bg-warning">Required Option</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        ${option.description ? `<p class="text-muted small">${option.description}</p>` : ''}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-primary btn-sm" onclick="editOption(${option.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewOptionDetails(${option.id})">
                                <i class="fas fa-eye"></i> Details
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteOption(${option.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        optionsGrid.innerHTML = optionsHTML;
        
    } catch (error) {
        console.error('Error loading options:', error);
        document.getElementById('optionsGrid').innerHTML = `
            <div class="col-12 text-center text-danger py-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h4>Error Loading Options</h4>
                <p>Please try again later.</p>
            </div>
        `;
    }
}

function updateCategoryFilter(options) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;
    
    const currentValue = categoryFilter.value;
    const categories = [...new Set(options.map(option => option.category).filter(category => category))];
    
    categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
        categories.map(category => `<option value="${category}">${category}</option>`).join('');
    
    if (currentValue && categories.includes(currentValue)) {
        categoryFilter.value = currentValue;
    }
}

function showOptionForm(optionData = null) {
    const modal = new bootstrap.Modal(document.getElementById('optionFormModal'));
    const title = document.getElementById('optionFormTitle');
    const form = document.getElementById('optionForm');
    
    if (optionData) {
        title.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Option';
        currentEditingOptionId = optionData.id;
        
        // Populate form with option data
        Object.keys(optionData).forEach(key => {
            const field = document.getElementById('option' + key.charAt(0).toUpperCase() + key.slice(1));
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = !!optionData[key];
                } else if (optionData[key] !== null && optionData[key] !== undefined) {
                    field.value = optionData[key];
                }
            }
        });
    } else {
        title.innerHTML = '<i class="fas fa-cogs me-2"></i>Add New Option';
        currentEditingOptionId = null;
        form.reset();
        // Set default values
        document.getElementById('optionStatus').value = 'ACTIVE';
    }
    
    modal.show();
}

async function saveOption() {
    try {
        const form = document.getElementById('optionForm');
        const formData = new FormData(form);
        const optionData = {};
        
        for (const [key, value] of formData.entries()) {
            if (value !== '') {
                optionData[key] = value;
            }
        }
        
        // Handle checkbox
        optionData.required = document.getElementById('optionRequired').checked;
        
        // Validate form
        const errors = utils.validateForm(form);
        if (errors.length > 0) {
            utils.showToast('Please fix the form errors: ' + errors.join(', '), 'error');
            return;
        }
        
        let response;
        if (currentEditingOptionId) {
            response = await api.options.update(currentEditingOptionId, optionData);
        } else {
            response = await api.options.create(optionData);
        }
        
        if (response) {
            utils.showToast('Option saved successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('optionFormModal')).hide();
            loadOptions(); // Refresh the options list
        }
        
    } catch (error) {
        console.error('Error saving option:', error);
        utils.showToast('Error saving option. Please try again.', 'error');
    }
}

async function editOption(optionId) {
    try {
        const response = await api.options.getById(optionId);
        if (response && response.data) {
            showOptionForm(response.data);
        }
    } catch (error) {
        console.error('Error loading option details:', error);
        utils.showToast('Error loading option details', 'error');
    }
}

async function deleteOption(optionId) {
    utils.showConfirmModal(
        'Delete Option',
        'Are you sure you want to delete this car option? This action cannot be undone.',
        async () => {
            try {
                await api.options.delete(optionId);
                utils.showToast('Option deleted successfully!', 'success');
                loadOptions(); // Refresh the options list
            } catch (error) {
                console.error('Error deleting option:', error);
                utils.showToast('Error deleting option. Please try again.', 'error');
            }
        }
    );
}

function viewOptionDetails(optionId) {
    // This would show a detailed view of the option
    console.log('View option details:', optionId);
    utils.showToast('Option details view coming soon!', 'info');
}
</script>
